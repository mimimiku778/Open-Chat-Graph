name: CI Test

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # Mock環境用のcomposeファイルを全ステップで使用
      COMPOSE_FILE: docker-compose.yml:docker-compose.mock.yml
      # CI環境フラグ（make ci-testでコンテナ起動をスキップ）
      CI: true
      # CI環境ではxdebugをインストールしない
      INSTALL_XDEBUG: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Setup environment
      run: |
        # .env.mock は不要（docker-compose.ci.yml で環境変数を直接設定）
        echo "CI environment setup complete"

    - name: Start mock environment
      run: |
        echo "Starting CI mock environment..."
        docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d
        echo "Checking container status..."
        docker compose -f docker-compose.yml -f docker-compose.ci.yml ps -a
        echo "Checking app container logs..."
        docker compose -f docker-compose.yml -f docker-compose.ci.yml logs app || true

    - name: Wait for services
      run: |
        echo "Waiting for MySQL..."
        for i in {1..30}; do
          if docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T mysql mysqladmin ping -uroot -ptest_root_pass --silent 2>/dev/null; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done

        echo "Waiting for App container..."
        for i in {1..30}; do
          if docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T app php -v > /dev/null 2>&1; then
            echo "App container is ready"
            break
          fi
          if [ $i -eq 5 ] || [ $i -eq 15 ] || [ $i -eq 25 ]; then
            echo "Container status at attempt $i:"
            docker compose -f docker-compose.yml -f docker-compose.ci.yml ps app || true
          fi
          echo "Waiting for App... ($i/30)"
          sleep 2
        done

        # 失敗した場合はログを出力
        if ! docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T app php -v > /dev/null 2>&1; then
          echo "ERROR: App container failed to start"
          echo "Container status:"
          docker compose -f docker-compose.yml -f docker-compose.ci.yml ps -a
          echo "App container logs:"
          docker compose -f docker-compose.yml -f docker-compose.ci.yml logs app
          exit 1
        fi

        echo "Waiting for LINE Mock API..."
        for i in {1..30}; do
          if curl -s http://localhost:9000 > /dev/null 2>&1; then
            echo "LINE Mock API is ready"
            break
          fi
          echo "Waiting for Mock API... ($i/30)"
          sleep 2
        done

    - name: Install dependencies
      run: |
        echo "Installing Composer dependencies..."
        docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T -u root -e COMPOSER_ALLOW_SUPERUSER=1 app composer install --no-dev --optimize-autoloader
        echo "Fixing vendor directory permissions..."
        docker compose -f docker-compose.yml -f docker-compose.ci.yml exec -T -u root app chown -R www-data:www-data /var/www/html/vendor

    - name: Initialize database and storage
      run: |
        echo "Initializing database and storage..."
        ./setup/local-setup.default.sh -y -n

    - name: Run CI tests
      run: |
        chmod +x ./.github/scripts/test-ci.sh ./.github/scripts/test-urls.sh ./.github/scripts/check-error-log.sh
        ./.github/scripts/test-ci.sh -y && ./.github/scripts/test-urls.sh && ./.github/scripts/check-error-log.sh

    - name: Handle test failure
      if: failure()
      run: |
        echo "=== Container logs (app) ==="
        docker compose -f docker-compose.yml -f docker-compose.ci.yml logs app --tail=100
        echo ""
        echo "=== Container logs (line-mock-api) ==="
        docker compose -f docker-compose.yml -f docker-compose.ci.yml logs line-mock-api --tail=100
        echo ""
        echo "=== Exception log ==="
        if [ -f storage/exception.log ]; then
          cat storage/exception.log
        else
          echo "No exception.log found"
        fi

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ci-logs
        path: |
          test-logs/
          storage/exception.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Show final status
      if: always()
      run: |
        echo "=== Final container status ==="
        docker compose -f docker-compose.yml -f docker-compose.ci.yml ps
