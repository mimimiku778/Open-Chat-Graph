name: CI Test

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # Mock環境用のcomposeファイルを全ステップで使用
      COMPOSE_FILE: docker-compose.yml:docker-compose.mock.yml

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup environment
      run: |
        # Docker Buildx (already available in ubuntu-latest)
        docker buildx version

        # Install mkcert
        sudo apt-get update
        sudo apt-get install -y libnss3-tools
        curl -JLO "https://dl.filippo.io/mkcert/latest?for=linux/amd64"
        chmod +x mkcert-v*-linux-amd64
        sudo mv mkcert-v*-linux-amd64 /usr/local/bin/mkcert
        mkcert -install

        # Create .env.mock configuration for CI
        cp docker/line-mock-api/.env.mock.example docker/line-mock-api/.env.mock
        # CI environment requires fixed mock API type and no delay
        sed -i 's/^MOCK_DELAY_ENABLED=.*/MOCK_DELAY_ENABLED=0/' docker/line-mock-api/.env.mock
        sed -i 's/^MOCK_API_TYPE=.*/MOCK_API_TYPE=fixed/' docker/line-mock-api/.env.mock

    - name: Run CI tests
      run: make ci-test

    - name: Handle test failure
      if: failure()
      run: |
        echo "=== Container logs (app) ==="
        docker compose logs app --tail=100
        echo ""
        echo "=== Container logs (line-mock-api) ==="
        docker compose logs line-mock-api --tail=100
        echo ""
        echo "=== Exception log ==="
        if [ -f storage/exception.log ]; then
          cat storage/exception.log
        else
          echo "No exception.log found"
        fi

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ci-logs
        path: |
          test-logs/
          storage/exception.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Show final status
      if: always()
      run: |
        echo "=== Final container status ==="
        docker compose ps
        echo ""
        make show
