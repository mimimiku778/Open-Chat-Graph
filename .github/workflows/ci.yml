name: CI Test

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    # skip-ciラベルまたはタイトルプレフィックスがある場合はスキップ
    # workflow_dispatch（手動実行）の場合は常に実行
    if: |
      github.event_name == 'workflow_dispatch' ||
      (!contains(github.event.pull_request.labels.*.name, 'skip-ci') &&
       !startsWith(github.event.pull_request.title, 'skip-ci'))
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read
      packages: read
      pull-requests: read  # paths-filterがPR時にREST APIでファイル一覧を取得するために必要
    env:
      # CI環境フラグ
      CI: true
      # CI環境ではxdebugをインストールしない
      INSTALL_XDEBUG: false

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for Docker-related changes
      uses: dorny/paths-filter@v3
      id: check_changes
      with:
        filters: |
          docker:
            - 'docker/**'
            - 'composer.json'
            - 'composer.lock'
          app-code:
            - 'app/**'
            - 'shadow/**'
            - 'shared/**'
            - 'batch/**'
            - 'public/**'
            - 'storage/**'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull or build app image
      run: |
        # Docker関連ファイルまたはアプリケーションコードに変更がある場合は必ずビルド
        if [ "${{ steps.check_changes.outputs.docker }}" = "true" ] || [ "${{ steps.check_changes.outputs.app-code }}" = "true" ]; then
          echo "Building app image (code or Docker-related files changed)"
          docker buildx build \
            --file docker/app/Dockerfile.ci \
            --cache-from type=gha,scope=app-ci \
            --cache-to type=gha,scope=app-ci,mode=max \
            --load \
            -t oc-review-mock-app:latest \
            .
        # 変更がない場合はプリビルドイメージを使用
        elif docker pull ghcr.io/${{ github.repository_owner }}/oc-review-mock-app:latest 2>/dev/null; then
          echo "✓ Using prebuilt app image"
          docker tag ghcr.io/${{ github.repository_owner }}/oc-review-mock-app:latest oc-review-mock-app:latest
        else
          echo "Building app image (no prebuilt image found)"
          docker buildx build \
            --file docker/app/Dockerfile.ci \
            --cache-from type=gha,scope=app-ci \
            --cache-to type=gha,scope=app-ci,mode=max \
            --load \
            -t oc-review-mock-app:latest \
            .
        fi

    - name: Pull or build LINE Mock API image
      run: |
        # Docker関連ファイルに変更がある場合は必ずビルド
        if [ "${{ steps.check_changes.outputs.docker }}" = "true" ]; then
          echo "Building LINE Mock API image (Docker-related files changed)"
          docker buildx build \
            --file docker/line-mock-api/Dockerfile.ci \
            --cache-from type=gha,scope=line-mock-api-ci \
            --cache-to type=gha,scope=line-mock-api-ci,mode=max \
            --load \
            -t oc-review-mock-line-mock-api:latest \
            ./docker/line-mock-api/
        # 変更がない場合はプリビルドイメージを使用
        elif docker pull ghcr.io/${{ github.repository_owner }}/oc-review-mock-line-mock-api:latest 2>/dev/null; then
          echo "✓ Using prebuilt LINE Mock API image"
          docker tag ghcr.io/${{ github.repository_owner }}/oc-review-mock-line-mock-api:latest oc-review-mock-line-mock-api:latest
        else
          echo "Building LINE Mock API image (no prebuilt image found)"
          docker buildx build \
            --file docker/line-mock-api/Dockerfile.ci \
            --cache-from type=gha,scope=line-mock-api-ci \
            --cache-to type=gha,scope=line-mock-api-ci,mode=max \
            --load \
            -t oc-review-mock-line-mock-api:latest \
            ./docker/line-mock-api/
        fi

    - name: Start mock environment
      run: |
        echo "Starting CI mock environment..."
        docker compose -f .github/docker-compose.ci.yml up -d

    - name: Wait for services
      run: |
        echo "Waiting for MySQL..."
        for i in {1..30}; do
          if docker compose -f .github/docker-compose.ci.yml exec -T mysql mysqladmin ping -uroot -ptest_root_pass --silent 2>/dev/null; then
            echo "MySQL is ready"
            break
          fi
          echo "Waiting for MySQL... ($i/30)"
          sleep 2
        done

        echo "Waiting for App container..."
        for i in {1..30}; do
          if docker compose -f .github/docker-compose.ci.yml exec -T app php -v > /dev/null 2>&1; then
            echo "App container is ready"
            break
          fi
          echo "Waiting for App... ($i/30)"
          sleep 2
        done

        echo "Waiting for LINE Mock API..."
        for i in {1..30}; do
          if curl -s http://localhost:9000 > /dev/null 2>&1; then
            echo "LINE Mock API is ready"
            break
          fi
          echo "Waiting for Mock API... ($i/30)"
          sleep 2
        done

    - name: Initialize database and storage
      env:
        COMPOSE_FILE: .github/docker-compose.ci.yml
      run: |
        echo "Initializing database and storage..."
        # CI環境: イメージに埋め込まれたコードを使用（権限設定は不要）
        ./setup/local-setup.default.sh -y

    - name: Run CI tests
      run: |
        chmod +x ./.github/scripts/test-ci.sh ./.github/scripts/test-urls.sh ./.github/scripts/check-error-log.sh
        ./.github/scripts/test-ci.sh -y && ./.github/scripts/test-urls.sh && ./.github/scripts/check-error-log.sh

    - name: Handle test failure
      if: failure()
      run: |
        echo "=== Container logs (app) ==="
        docker compose -f .github/docker-compose.ci.yml logs app --tail=100
        echo ""
        echo "=== Container logs (line-mock-api) ==="
        docker compose -f .github/docker-compose.ci.yml logs line-mock-api --tail=100
        echo ""
        echo "=== Exception log ==="
        if [ -f storage/exception.log ]; then
          cat storage/exception.log
        else
          echo "No exception.log found"
        fi

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ci-logs
        path: |
          test-logs/
          storage/exception.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Collect container logs on failure
      if: failure()
      run: |
        echo "=== Collecting container logs ==="
        mkdir -p container-logs
        docker compose -f .github/docker-compose.ci.yml logs app > container-logs/app.log 2>&1 || true
        docker compose -f .github/docker-compose.ci.yml logs mysql > container-logs/mysql.log 2>&1 || true
        docker compose -f .github/docker-compose.ci.yml logs line-mock-api > container-logs/line-mock-api.log 2>&1 || true
        docker compose -f .github/docker-compose.ci.yml exec -T app cat /var/log/apache2/error.log > container-logs/apache-error.log 2>&1 || true
        docker compose -f .github/docker-compose.ci.yml exec -T app ls -la /var/www/html/storage > container-logs/storage-ls.log 2>&1 || true
        docker compose -f .github/docker-compose.ci.yml exec -T app cat /var/www/html/local-secrets.php > container-logs/local-secrets.php 2>&1 || true

    - name: Upload container logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: container-logs
        path: container-logs/
        retention-days: 7
        if-no-files-found: ignore

    - name: Show final status
      if: always()
      run: |
        echo "=== Final container status ==="
        docker compose -f .github/docker-compose.ci.yml ps
