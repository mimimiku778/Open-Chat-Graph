name: Deploy to Production

on:
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    # PRãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸå ´åˆã€ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚ã«å®Ÿè¡Œ
    # ãŸã ã—ã€skip-ciãƒ©ãƒ™ãƒ«/ã‚¿ã‚¤ãƒˆãƒ«ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event.pull_request.merged == true &&
       !contains(github.event.pull_request.labels.*.name, 'skip-ci') &&
       !startsWith(github.event.pull_request.title, 'skip-ci'))
    runs-on: ubuntu-latest

    steps:
    # PRãƒãƒ¼ã‚¸æ™‚ã¯CIãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¦ã„ã‚‹ã‹ç¢ºèª
    - name: Check CI status
      if: github.event_name == 'pull_request'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        echo "Checking CI Test status for PR #${{ github.event.pull_request.number }}..."

        # PRã®head SHA ã‚’å–å¾—
        HEAD_SHA="${{ github.event.pull_request.head.sha }}"

        # CI Test ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®çµæœã‚’ç¢ºèª
        CI_STATUS=$(gh api repos/${{ github.repository }}/commits/${HEAD_SHA}/check-runs \
          --jq '.check_runs[] | select(.name == "test") | .conclusion' | head -1)

        echo "CI Test status: $CI_STATUS"

        if [ "$CI_STATUS" != "success" ]; then
          echo "::error::CI Test has not passed (status: $CI_STATUS). Aborting deployment."
          exit 1
        fi

        echo "CI Test passed. Proceeding with deployment."

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh
        # base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç§˜å¯†éµã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦æ›¸ãè¾¼ã¿
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 -d > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        # ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã¨æœ«å°¾ã‚’ç¢ºèªï¼ˆç§˜å¯†éµã¯è¡¨ç¤ºã—ãªã„ï¼‰
        echo "Key file size: $(wc -c < ~/.ssh/id_rsa) bytes"
        echo "Key file lines: $(wc -l < ~/.ssh/id_rsa)"
        head -n 1 ~/.ssh/id_rsa

    - name: Deploy
      run: |
        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ~/.ssh/id_rsa -p ${{ vars.SSH_PORT }} ${{ vars.SSH_USER }}@${{ vars.SSH_HOST }} "cd ${{ vars.SSH_PATH }} && git fetch origin && git reset --hard origin/main"

    - name: Checkout repository
      if: |
        github.event_name == 'pull_request' &&
        !contains(github.event.pull_request.labels.*.name, 'skip-post') &&
        !startsWith(github.event.pull_request.title, 'skip-post')
      uses: actions/checkout@v4

    - name: Setup Node.js
      if: |
        github.event_name == 'pull_request' &&
        !contains(github.event.pull_request.labels.*.name, 'skip-post') &&
        !startsWith(github.event.pull_request.title, 'skip-post')
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install twitter-api-v2
      if: |
        github.event_name == 'pull_request' &&
        !contains(github.event.pull_request.labels.*.name, 'skip-post') &&
        !startsWith(github.event.pull_request.title, 'skip-post')
      run: npm install twitter-api-v2

    - name: Create post script
      if: |
        github.event_name == 'pull_request' &&
        !contains(github.event.pull_request.labels.*.name, 'skip-post') &&
        !startsWith(github.event.pull_request.title, 'skip-post')
      run: |
        cat > post-pr-merge.js << 'EOF'
        import { TwitterApi } from 'twitter-api-v2';

        const client = new TwitterApi({
          appKey: process.env.TWITTER_API_KEY,
          appSecret: process.env.TWITTER_API_SECRET,
          accessToken: process.env.TWITTER_ACCESS_TOKEN,
          accessSecret: process.env.TWITTER_ACCESS_TOKEN_SECRET,
        });

        async function postTweet() {
          try {
            const prNumber = process.env.PR_NUMBER;
            const prTitle = process.env.PR_TITLE;
            const prUrl = process.env.PR_URL;
            const prAuthor = process.env.PR_AUTHOR;

            const message = 'ğŸš€ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒãƒ¼ã‚¸ã•ã‚Œã€ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã—ãŸ\n\n' +
              '#' + prNumber + ': ' + prTitle + '\n' +
              'By @' + prAuthor + '\n\n' +
              '#ã‚ªãƒ—ãƒãƒ£ã‚°ãƒ©ãƒ• https://openchat-review.me' + '\n\n' +
              prUrl;

            const tweet = await client.v2.tweet(message);
            console.log('Tweet posted: ' + tweet.data.id);

          } catch (error) {
            console.error('Error:', error);
            process.exit(1);
          }
        }

        postTweet();
        EOF

    - name: Post to X (Twitter)
      if: |
        github.event_name == 'pull_request' &&
        !contains(github.event.pull_request.labels.*.name, 'skip-post') &&
        !startsWith(github.event.pull_request.title, 'skip-post')
      env:
        TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
        TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
        TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
        TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        PR_TITLE: ${{ github.event.pull_request.title }}
        PR_URL: ${{ github.event.pull_request.html_url }}
        PR_AUTHOR: ${{ github.event.pull_request.user.login }}
      run: node post-pr-merge.js
